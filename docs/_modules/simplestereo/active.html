<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>simplestereo.active &#8212; SimpleStereo 1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=601dbdee" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=0d33fa41" />
    <script src="../../_static/documentation_options.js?v=29a6c3e3"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SimpleStereo 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">simplestereo.active</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for simplestereo.active</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">active</span>
<span class="sd">======</span>
<span class="sd">Contains classes to manage active stereo algorithms and helper</span>
<span class="sd">functions.</span>
<span class="sd">This module contains both conventional active stereo (2 cameras +</span>
<span class="sd">projector) and structured-light (1 camera + projector) methods.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">map_coordinates</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>                   <span class="c1"># Temporary fix to avoid</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>             <span class="c1"># segmentation fault error</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">simplestereo</span> <span class="k">as</span> <span class="nn">ss</span>


<div class="viewcode-block" id="generateGrayCodeImgs">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.generateGrayCodeImgs">[docs]</a>
<span class="k">def</span> <span class="nf">generateGrayCodeImgs</span><span class="p">(</span><span class="n">targetDir</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate Gray Codes and save it to PNG images.</span>
<span class="sd">    </span>
<span class="sd">    Starts from the couple of images *0.png* and *1.png* (one is the</span>
<span class="sd">    inverse of the other). Then 2.png is coupled with 3.png and so on.</span>
<span class="sd">    First half contains vertical stripes, followed by horizontal ones.</span>
<span class="sd">    The function stores also a *black.png* and *white.png* images for</span>
<span class="sd">    threshold calibration.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    targetDir : string</span>
<span class="sd">        Path to the directory where to save Gray codes. Directory is created if not exists.</span>
<span class="sd">    resolution : tuple</span>
<span class="sd">        Pixel dimensions of the images as (width, height) tuple (to be matched with projector resolution).</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Number of generated patterns (black and white are *not* considered in this count).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">resolution</span>
    <span class="n">graycode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">structured_light_GrayCodePattern</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    
    <span class="n">num_patterns</span> <span class="o">=</span> <span class="n">graycode</span><span class="o">.</span><span class="n">getNumberOfPatternImages</span><span class="p">()</span> <span class="c1"># Surely an even number</span>
    
    <span class="c1"># Generate patterns    </span>
    <span class="n">exp_patterns</span> <span class="o">=</span> <span class="n">graycode</span><span class="o">.</span><span class="n">generate</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">targetDir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">targetDir</span><span class="p">)</span>
    
    <span class="c1"># Save images to chosen directory</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_patterns</span><span class="p">):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">targetDir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">exp_patterns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># Additionally save black and white images (not counted in return value)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">targetDir</span><span class="p">,</span><span class="s1">&#39;black.png&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">targetDir</span><span class="p">,</span><span class="s1">&#39;white.png&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">num_patterns</span></div>



<span class="k">def</span> <span class="nf">_getCentralPeak</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get maximum intensity pixel position in a fringe with central stripe</span>
<span class="sd">    built from :func:`ss.active.buildFringe`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    length : int</span>
<span class="sd">        Resolution along the axis.</span>
<span class="sd">    period : float</span>
<span class="sd">        Fringe period along the same axis.</span>
<span class="sd">    shift : float, optional</span>
<span class="sd">        Consider the shift used in the cosine function.</span>
<span class="sd">        Default to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">period</span>
    
    <span class="k">return</span> <span class="n">period</span><span class="o">*</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">shift</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    

<div class="viewcode-block" id="buildFringe">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.buildFringe">[docs]</a>
<span class="k">def</span> <span class="nf">buildFringe</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span><span class="mi">720</span><span class="p">),</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stripeColor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build sinusoidal fringe image.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    period : float</span>
<span class="sd">        Fringe period along x axis, in pixels.</span>
<span class="sd">    shift : float, optional</span>
<span class="sd">        Shift to apply. Default to 0.</span>
<span class="sd">    dims : tuple, optional</span>
<span class="sd">        Image dimensions as (width, height). Default to (1280,720).</span>
<span class="sd">    vertical : bool, optional</span>
<span class="sd">        If True, fringe is build along vertical. Default to False</span>
<span class="sd">        (horizontal).</span>
<span class="sd">    stripeColor : str, optional</span>
<span class="sd">        Color of the stripe chosen from &#39;blue&#39;,&#39;green&#39; or &#39;red&#39;.</span>
<span class="sd">        Also &#39;b&#39;, &#39;g&#39;, &#39;r&#39; are accepted.</span>
<span class="sd">        Default to None (no stripe drawn).</span>
<span class="sd">    dtype: numpy.dtype</span>
<span class="sd">        Image is scaled in the range 0 - max value to match `dtype`.</span>
<span class="sd">        Default np.uint8 (max 255).</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Fringe image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Swap dimensions</span>
    
    <span class="n">row</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">period</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    
    <span class="c1"># If output is integer, use its max value as amplitude</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">char</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">typecodes</span><span class="p">[</span><span class="s1">&#39;AllInteger&#39;</span><span class="p">]:</span>
        <span class="n">row</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    
    <span class="k">if</span> <span class="n">stripeColor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">_getCentralPeak</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">period</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Leave the only relevant color and set other channels to 0</span>
        <span class="k">if</span> <span class="n">stripeColor</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">stripeColor</span><span class="o">==</span><span class="s1">&#39;red&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">elif</span> <span class="n">stripeColor</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">or</span> <span class="n">stripeColor</span><span class="o">==</span><span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">stripeColor</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span> <span class="ow">or</span> <span class="n">stripeColor</span><span class="o">==</span><span class="s1">&#39;blue&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;stripeColor value not permitted!&quot;</span><span class="p">)</span>
    
    <span class="n">fullFringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Left-&gt;Right becomes Top-&gt;Bottom</span>
        <span class="n">fullFringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">fullFringe</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">fullFringe</span></div>



<div class="viewcode-block" id="buildBinaryFringe">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.buildBinaryFringe">[docs]</a>
<span class="k">def</span> <span class="nf">buildBinaryFringe</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span><span class="mi">720</span><span class="p">),</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stripeColor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build binary fringe image.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    period : int</span>
<span class="sd">        Fringe period along x axis, in pixels. An integer is expected.</span>
<span class="sd">        If a float is passed, it will be converted to integer.</span>
<span class="sd">    shift : float</span>
<span class="sd">        Shift to apply. Default to 0.</span>
<span class="sd">    dims : tuple</span>
<span class="sd">        Image dimensions as (width, height).</span>
<span class="sd">    vertical : bool</span>
<span class="sd">        If True, fringe is build along vertical. Default to False</span>
<span class="sd">        (horizontal fringe direction).</span>
<span class="sd">    stripeColor : str, optional</span>
<span class="sd">        Color of the stripe chosen from &#39;blue&#39;,&#39;green&#39; or &#39;red&#39;.</span>
<span class="sd">        Also &#39;b&#39;, &#39;g&#39;, &#39;r&#39; are accepted.</span>
<span class="sd">        Default to None (no stripe drawn).</span>
<span class="sd">    dtype: numpy.dtype</span>
<span class="sd">        Image is scaled in the range 0 - max value to match `dtype`.</span>
<span class="sd">        Default np.uint8 (max 255).</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Fringe image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Swap dimensions</span>
    
    <span class="c1"># Binarise</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">row</span><span class="p">[</span><span class="n">period</span><span class="o">//</span><span class="mi">4</span><span class="p">:</span><span class="n">period</span><span class="o">//</span><span class="mi">2</span> <span class="o">+</span> <span class="n">period</span><span class="o">//</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">row</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    
    <span class="k">if</span> <span class="n">stripeColor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">_getCentralPeak</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">period</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">period</span><span class="p">)</span>
        
        <span class="c1"># Leave the only relevant color and set other channels to 0</span>
        <span class="k">if</span> <span class="n">stripeColor</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">stripeColor</span><span class="o">==</span><span class="s1">&#39;red&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="k">elif</span> <span class="n">stripeColor</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">or</span> <span class="n">stripeColor</span><span class="o">==</span><span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">stripeColor</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span> <span class="ow">or</span> <span class="n">stripeColor</span><span class="o">==</span><span class="s1">&#39;blue&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;stripeColor value not permitted!&quot;</span><span class="p">)</span>
    
    <span class="n">fullFringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Left-&gt;Right becomes Top-&gt;Bottom</span>
        <span class="n">fullFringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">fullFringe</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">fullFringe</span></div>

    

<div class="viewcode-block" id="buildAnaglyphFringe">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.buildAnaglyphFringe">[docs]</a>
<span class="k">def</span> <span class="nf">buildAnaglyphFringe</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span><span class="mi">720</span><span class="p">),</span> <span class="n">vertical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build sinusoidal anaglyph fringe image.</span>
<span class="sd">    </span>
<span class="sd">    Assumes BGR images, using blue and red as complementary colors and</span>
<span class="sd">    green as central stripe. This allows to actually extract three </span>
<span class="sd">    different images from a single scan. Red and blue can be subtracted</span>
<span class="sd">    to suppress DC component. Green serves the purpose to obtain a </span>
<span class="sd">    reference phase in the FTP algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    period : float</span>
<span class="sd">        Fringe period along x axis, in pixels.</span>
<span class="sd">    shift : float</span>
<span class="sd">        Shift to apply. Default to 0.</span>
<span class="sd">    dims : tuple</span>
<span class="sd">        Image dimensions as (width, height).</span>
<span class="sd">    vertical : bool</span>
<span class="sd">        If True, fringe is build along vertical. Default to False (horizontal).</span>
<span class="sd">    dtype: numpy.dtype</span>
<span class="sd">        Image is scaled in the range 0 - max value to match `dtype`.</span>
<span class="sd">        Default np.uint8 (max 255).</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Fringe image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Swap dimensions</span>
    
    <span class="c1"># Red and blue shifted by pi    </span>
    <span class="n">rowR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">period</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">rowB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">period</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="c1"># Green central peak</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">_getCentralPeak</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">period</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">left</span><span class="o">+</span><span class="n">period</span><span class="p">)</span>
    <span class="n">rowG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rowR</span><span class="p">)</span>
    <span class="n">rowG</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">rowR</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">]</span>
    
    <span class="c1"># Stack as BGR row</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">rowB</span><span class="p">,</span><span class="n">rowG</span><span class="p">,</span><span class="n">rowR</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Repeat and cast to type    </span>
    <span class="n">fullFringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">vertical</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Left-&gt;Right becomes Top-&gt;Bottom</span>
        <span class="n">fullFringe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">fullFringe</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">fullFringe</span></div>

    
    
<div class="viewcode-block" id="findCentralStripe">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.findCentralStripe">[docs]</a>
<span class="k">def</span> <span class="nf">findCentralStripe</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find coordinates of a colored stripe in the image.</span>
<span class="sd">    </span>
<span class="sd">    Search is done with subpixel accuracy only along the x-axis</span>
<span class="sd">    direction.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : numpy.ndarray</span>
<span class="sd">        BGR image with a colored vertical stripe.</span>
<span class="sd">    color : str, optional</span>
<span class="sd">        Color of the original stripe as &#39;blue&#39;,&#39;green&#39; or &#39;red&#39;.</span>
<span class="sd">        Also &#39;b&#39;, &#39;g&#39;, &#39;r&#39; are accepted.</span>
<span class="sd">        Default to &#39;red&#39;.</span>
<span class="sd">    sensitivity : float, optional</span>
<span class="sd">        Sensitivity for color matching in [0,1]. Default to 0.5.</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        See `scipy.interpolate.interp1d` `kind` parameter.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        x,y coordinates of stripe centers with shape (n,2). </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">       The search is done along a single dimension, the x-axis.</span>
<span class="sd">       Missing values are filled with nearest-value interpolation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sensitivity</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sensitivity</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Threshold must be in the interval [0,1]!&quot;</span><span class="p">)</span>
    
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">maxValue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
    
    <span class="c1"># Reduce BGR image to the relevant channel </span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">color</span><span class="o">==</span><span class="s1">&#39;red&#39;</span><span class="p">:</span>
        <span class="n">fringe</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">or</span> <span class="n">color</span><span class="o">==</span><span class="s1">&#39;green&#39;</span><span class="p">:</span>
        <span class="n">fringe</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span> <span class="ow">or</span> <span class="n">color</span><span class="o">==</span><span class="s1">&#39;blue&#39;</span><span class="p">:</span>
        <span class="n">fringe</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Color value not permitted!&quot;</span><span class="p">)</span>
    
    
    <span class="n">lower_color_bound</span> <span class="o">=</span> <span class="n">maxValue</span><span class="o">*</span><span class="n">sensitivity</span>
    <span class="n">fringe</span><span class="p">[</span><span class="n">fringe</span> <span class="o">&lt;</span> <span class="n">lower_color_bound</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">getCenters</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Weighted average of color values</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">s</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="c1"># Some NaN expected</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">getCenters</span><span class="p">(</span><span class="n">fringe</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="c1"># Line not found</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>              <span class="c1"># Consider pixel center, as first is in y=0.5</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                   <span class="c1"># Remove coords with NaN</span>
    
    
    <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span> <span class="c1"># Interpolate</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">T</span></div>



<span class="c1">########################################</span>
<span class="c1">###### (c) Pasquale Lafiosca 2020 ######</span>
<span class="c1">########################################</span>
<div class="viewcode-block" id="StereoFTP">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP">[docs]</a>
<span class="k">class</span> <span class="nc">StereoFTP</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manager of the Stereo Fourier Transform Profilometry.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stereoRig : StereoRig</span>
<span class="sd">        A stereo rig object with camera in position 1 (world origin) and projector in</span>
<span class="sd">        position 2.</span>
<span class="sd">    fringeDims : tuple</span>
<span class="sd">        Dimensions of projector image as (width, height).</span>
<span class="sd">    period : float</span>
<span class="sd">        Period of the fringe (in pixels).</span>
<span class="sd">    stripeColor : str, optional</span>
<span class="sd">        BGR color used for the central stripe to be chosen among &quot;blue&quot;,</span>
<span class="sd">        &quot;green&quot; or &quot;red&quot;. Also &quot;b&quot;, &quot;g&quot;, &quot;r&quot; accepted.</span>
<span class="sd">        Default to &quot;red&quot;.</span>
<span class="sd">    stripeSensitivity : float, optional</span>
<span class="sd">        Sensitivity to find the stripe. See :func:`findCentralStripe()`.</span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">    .. note::</span>
<span class="sd">        Working details in the paper Pasquale Lafiosca et al.,</span>
<span class="sd">        &quot;Automated Aircraft Dent Inspection via a Modified Fourier</span>
<span class="sd">        Transform Profilometry Algorithm&quot;,</span>
<span class="sd">        Sensors, 2022, https://doi.org/10.3390/s22020433</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stereoRig</span><span class="p">,</span> <span class="n">fringe</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">stripeColor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">stripeSensitivity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span> <span class="o">=</span> <span class="n">stereoRig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fringe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertGrayscale</span><span class="p">(</span><span class="n">fringe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fringeDims</span> <span class="o">=</span> <span class="n">fringe</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (width, height)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripeColor</span> <span class="o">=</span> <span class="n">stripeColor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripeSensitivity</span> <span class="o">=</span> <span class="n">stripeSensitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span> <span class="o">=</span> <span class="n">_getCentralPeak</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fringeDims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">getFundamentalMatrix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">,</span> <span class="n">commonR</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">rectification</span><span class="o">.</span><span class="n">_lowLevelRectify</span><span class="p">(</span><span class="n">stereoRig</span><span class="p">)</span>
        
        <span class="c1">### Get epipole on projector</span>
        <span class="c1"># Project camera position (0,0,0) onto projector image plane.</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">/</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1">### Get inverse common orientation and extend to 4x4 transform</span>
        <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">commonR</span><span class="p">)</span>
        <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">R_inv</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">R_inv</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span> <span class="o">=</span> <span class="n">R_inv</span>
        
    
<div class="viewcode-block" id="StereoFTP.convertGrayscale">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP.convertGrayscale">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convertGrayscale</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert to grayscale using max.</span>
<span class="sd">        </span>
<span class="sd">        This keeps highest BGR value over the central stripe</span>
<span class="sd">        (e.g. (0,0,255) -&gt; 255), allowing the FFT to work properly.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            BGR image.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Grayscale image.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        .. todo:: Gamma correction may be implemented as a parameter.</span>
<span class="sd">           </span>
<span class="sd">        .. note::</span>
<span class="sd">           I&#39;ve tried different approaches, but the simple `max`</span>
<span class="sd">           works best at converting the stripe to white.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

        
    
    <span class="k">def</span> <span class="nf">_getProjectorMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find projector image points corresponding to each camera pixel</span>
<span class="sd">        after projection on reference plane to build coordinates and</span>
<span class="sd">        virtual reference image (as seen from camera)</span>
<span class="sd">        </span>
<span class="sd">        Points are processed and returned in row-major order.</span>
<span class="sd">        The center of each pixel is considered as point.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Desidered distance of the reference plane from the camera.</span>
<span class="sd">        interpolation : int</span>
<span class="sd">            See OpenCV interpolation constants. Default to `cv2.INTER_CUBIC`.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Matrix of points with same width and height of camera resolution.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        .. note:: </span>
<span class="sd">           Corresponding points on reference plane do not vary. They have to</span>
<span class="sd">           be calculated only during initialization considering the chosen </span>
<span class="sd">           reference plane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">res1</span>
        <span class="n">invAc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">)</span>
        
        <span class="c1"># Build grid of x,y coordinates</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">w</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># Consider center of pixel: it can be thought as</span>
        <span class="c1"># the center of the light beam entering the camera</span>
        <span class="c1"># Experiments showed that this is needed for projCoords</span>
        <span class="c1"># but *not* for the virtual reference image</span>
        <span class="c1"># (depends on how cv2.remap works, integer indexes</span>
        <span class="c1"># of original images are used)</span>
        <span class="n">doubleGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">grid</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">grid</span><span class="p">))</span>
        <span class="n">doubleGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doubleGrid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># For *both* grids</span>
        <span class="c1"># de-project from camera to reference plane</span>
        <span class="c1"># and project on projector&#39;s image plane.</span>
        
        <span class="c1"># 1st half: To get exact projector coordinates from camera x,y coordinates (center of pixel)</span>
        <span class="c1"># 2d half: To build a virtual reference image (using *integer* pixel coordinates)</span>
        <span class="n">pp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">doubleGrid</span><span class="p">,</span>
            <span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invAc</span><span class="p">),</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span><span class="p">)</span>
        
        <span class="c1"># Separate the two grids</span>
        <span class="n">pointsA</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="n">h</span><span class="o">*</span><span class="n">w</span><span class="p">:]</span>                   <span class="c1"># 1st half</span>
        <span class="n">projCoords</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[:</span><span class="n">h</span><span class="o">*</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 2nd half</span>
        
        <span class="n">mapx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pointsA</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">mapy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pointsA</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">virtualReferenceImg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fringe</span><span class="p">,</span> <span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span><span class="p">,</span> <span class="n">interpolation</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="n">projCoords</span><span class="p">,</span> <span class="n">virtualReferenceImg</span>
    
    
    <span class="k">def</span> <span class="nf">_calculateCameraFrequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objPoints</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate fc from system geometry, fp and object points value.</span>
<span class="sd">        </span>
<span class="sd">        Draw a plane at given z distance in front of the camera.</span>
<span class="sd">        Find period size on it and project that size on camera.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span>
        <span class="n">Dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span>
        
        <span class="n">Ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">R</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span>
        
        <span class="n">Op</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="c1">#ObjCenter = np.array([[[0],[0],[z]]], dtype=np.float32)</span>
        <span class="n">objPoints</span> <span class="o">=</span> <span class="n">objPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">objPoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Send center of reference plane to projector</span>
        <span class="n">pCenter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">objPoints</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span><span class="p">)</span>
        <span class="c1"># Now we are in the projected image</span>
        <span class="c1"># Perfect fringe pattern. No distortion</span>
        
        <span class="c1"># Find two points at distance Tp (period on projector)</span>
        <span class="n">halfPeriodP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        
        <span class="n">leftX</span> <span class="o">=</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">halfPeriodP</span>
        <span class="n">rightX</span> <span class="o">=</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfPeriodP</span>
        
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">leftX</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rightX</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Shape (2, 1, 2)</span>
        
        <span class="c1">### Deproject on world plane</span>
        <span class="c1"># Un-distort points for the projector means to distort</span>
        <span class="c1"># as the pinhole camera model is made for cameras</span>
        <span class="c1"># and we are projecting back to 3D world</span>
        <span class="n">distortedPoints</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">Ap</span><span class="p">)</span> <span class="c1"># Shape (2, 1, 2)</span>
        
        <span class="c1"># De-project in homogeneous coordinates at known world z</span>
        <span class="c1"># s * pp = Ap[R | T] * [pw 1].T</span>
        <span class="n">invARp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Ap</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">distortedPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">objPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="c1"># Shape (2, 3)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">objPoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Shape (2, 1)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">invARp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="c1"># Shape (2n, 3)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">Op</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">h</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]]</span> <span class="c1"># Shape (2n, )</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">Op</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># Project on camera image plane (also applying lens distortion).</span>
        <span class="c1"># b points are seen by the camera (from world origin)</span>
        <span class="n">pc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">Ac</span><span class="p">,</span> <span class="n">Dc</span><span class="p">)</span> <span class="c1"># Shape (2n, 1, 2)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
        <span class="c1"># Now we have couples of 2 points on the camera that differ</span>
        <span class="c1"># exactly one projector period from each other</span>
        <span class="c1"># as seen by the camera</span>
        <span class="c1"># Use the first Euclid theorem to get the effective period</span>
        <span class="n">Tc</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Return frequency</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">Tc</span>    
    
    <span class="k">def</span> <span class="nf">_triangulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camPoints</span><span class="p">,</span> <span class="n">p_x</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each camera undistorted point (c_x, c_y) and corresponding </span>
<span class="sd">        projector x-value p_x, find 3D point using Fundamental matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">camPoints</span> <span class="o">=</span> <span class="n">camPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">camPoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">camPoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Add coordinate x shift</span>
        <span class="n">camPoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Add coordinate y shift</span>
        
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">camPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">epipolarLinesP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">camPoints</span><span class="p">,</span> <span class="n">ones</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1"># Shape (n, 3)</span>
        
        <span class="c1">#ones = np.ones((1,n), dtype=camPoints.dtype)</span>
        <span class="c1">#epipolarLinesP = self.F.dot( np.vstack((camPoints.T, ones)) ) # Shape (3, n)</span>
        <span class="c1">#epipolarLinesP = epipolarLinesP.T # Shape (n, 3)</span>
        
        <span class="c1"># Get p_y values</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">p_x</span><span class="p">):</span>
            <span class="n">p_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">p_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">camPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="n">p_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">p_y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">epipolarLinesP</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p_x</span> <span class="o">+</span> <span class="n">epipolarLinesP</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">epipolarLinesP</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="n">p_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">projPoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">p_y</span><span class="p">))</span> <span class="c1"># Shape (n, 2)</span>
        
        <span class="c1">### Triangulate</span>
        <span class="c1"># Apply rectification to cam (already undistorted)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">camPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">)</span>
        
        <span class="c1"># Apply lens correction to projector and rectify</span>
        <span class="n">Ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">projPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">)</span>
        
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,[</span><span class="mi">0</span><span class="p">]])</span>
        
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">camPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="p">)</span> <span class="c1"># Shape (n, 3)</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">getBaseline</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">pc</span><span class="o">/</span><span class="n">disparity</span><span class="p">)</span> <span class="c1"># Shape (n, 3)</span>
        
        <span class="n">pw</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
        
<div class="viewcode-block" id="StereoFTP.getCloud">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP.getCloud">[docs]</a>
    <span class="k">def</span> <span class="nf">getCloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">,</span> <span class="n">radius_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unwrappingMethod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an image and get the point cloud.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imgObj : numpy.ndarray</span>
<span class="sd">            BGR image acquired by the camera.</span>
<span class="sd">        radius_factor : float, optional</span>
<span class="sd">            Radius factor of the pass-band filter. Default to 0.5.</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest in the format (x,y,width,height)</span>
<span class="sd">            where x,y is the upper left corner. Default to None.</span>
<span class="sd">        unwrappingMethod : function, optional</span>
<span class="sd">            Pointer to chosen unwrapping function. It must take the phase</span>
<span class="sd">            as the only argument. If None (default), `np.unwrap`is used.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Point cloud with shape (height,width,3), with height and width </span>
<span class="sd">        same as the input image or selected `roi`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check that is a color image</span>
        <span class="k">if</span> <span class="n">imgObj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;image must be a BGR color image!&quot;</span><span class="p">)</span>
        
        <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">res1</span> <span class="c1"># Camera resolution</span>
        
        <span class="c1"># Undistort camera image</span>
        <span class="n">imgObj</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Cut image to given roi</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
            <span class="n">imgObj</span> <span class="o">=</span> <span class="n">imgObj</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span><span class="p">)</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
            
        <span class="c1">### Estimate camera carrier frequency fc    </span>
        <span class="c1"># Find central stripe on camera image</span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">findCentralStripe</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeColor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeSensitivity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stripe_cam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Central stripe not found in image!&quot;</span><span class="p">)</span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">stripe_cam</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># x, y camera points (already undistorted)</span>
        
        <span class="c1"># Find integer indexes of stripe on camera (round half down)</span>
        <span class="c1">#cam_indexes = np.ceil(objStripe-0.5).astype(np.int64) # As (x,y)</span>
        <span class="c1"># Use undistorted values</span>
        <span class="n">stripe_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">stripe_cam</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="c1"># As (x,y)</span>
        
        <span class="c1">### Find world points corresponding to stripe</span>
        <span class="n">stripe_world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangulate</span><span class="p">(</span><span class="n">stripe_cam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        <span class="c1">#return stripe_world</span>
        
        <span class="c1">### Find z to build virtual reference plane</span>
        <span class="n">z_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># For each point (= for each row) estimate fc</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateCameraFrequency</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">)</span>
        
        <span class="c1">### Get projector mapping</span>
        <span class="n">projCoords</span><span class="p">,</span> <span class="n">imgR_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getProjectorMapping</span><span class="p">(</span><span class="n">z_plane</span><span class="p">)</span>
        <span class="n">imgR_gray</span> <span class="o">=</span> <span class="n">imgR_gray</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="n">projCoords</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        
        <span class="c1"># Preprocess image for phase analysis</span>
        <span class="n">imgObj_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertGrayscale</span><span class="p">(</span><span class="n">imgObj</span><span class="p">)</span>
        
        <span class="c1"># FFT</span>
        <span class="n">G0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgR_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># FFT on x dimension</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgObj_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">roi_w</span><span class="p">)</span>

        <span class="c1"># Pass-band filter parameters</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius_factor</span><span class="o">*</span><span class="n">fc</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">radius</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">radius</span>
        
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Virtual reference&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Object&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Virtual reference&quot;</span><span class="p">,</span> <span class="n">imgR_gray</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Object&quot;</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press a key over the images to continue...&quot;</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
            
            <span class="c1"># Get discrete indexes of frequencies</span>
            <span class="n">fIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fminIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fmaxIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmax</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Middle row FFT module&quot;</span><span class="p">)</span>
            <span class="c1"># Show module of FFTs</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G0</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G0|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="c1"># Show filtered band</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fminIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fmaxIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fc=</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>    
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Phase filtering</span>
        <span class="n">mask_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmin</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G0</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G0</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Inverse FFT</span>
        <span class="n">g0hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Show filtered object image</span>
        <span class="c1">#tmp = ghat.real</span>
        <span class="c1">#cv2.imshow(&quot;TEMP OBJ FILTERED&quot;, (tmp-np.min(tmp))/np.ptp(tmp))</span>
        <span class="c1">#cv2.waitKey(0)</span>
        
        <span class="c1"># Build the new signal and get its phase</span>
        <span class="c1"># NB Numerically this is not equivalent to the phase difference.</span>
        <span class="c1"># https://stackoverflow.com/questions/69176709/numerical-differences-in-numpy-conjugate-and-angle/69178618#69178618</span>
        <span class="n">newSignal</span> <span class="o">=</span> <span class="n">ghat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">g0hat</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">newSignal</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">unwrappingMethod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unwrap along the direction perpendicular to the fringe</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">discont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># And remove jumps along other direction</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">phaseUnwrapped</span><span class="p">,</span> <span class="n">discont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">unwrappingMethod</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
              
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Middle row unwrapped phase&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">phase</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Phase shift&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">phaseUnwrapped</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unwrapped phase shift&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel position&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1">### Lazy shortcut for many values</span>
        <span class="n">Ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span>
        <span class="n">Dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span>
        
        <span class="n">Ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">R</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span>
        
        <span class="c1">### Find k values from central stripe</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        # Calculate absolute phase shift [S. Zhang 2006 Novel method...]</span>
<span class="sd">        theta_shift = phaseUnwrapped[cam_indexes[:,1],cam_indexes[:,0]]</span>
<span class="sd">        theta_shift = np.mean(theta_shift)</span>
<span class="sd">        phaseUnwrapped = phaseUnwrapped - theta_shift</span>
<span class="sd">        phaseUnwrapped = phaseUnwrapped.reshape(-1,1)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># Alternative and more accurate method: we know k is an integer!</span>
        <span class="c1"># Finding and rounding k we reduce numerical errors.</span>
        
        <span class="n">theta</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span><span class="p">[</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># Phase values at stripe locations</span>
        <span class="n">u_A</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]][:,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Stripe over reference as seen from projector </span>
        <span class="c1"># absolutePhase = knownPhase + phaseShift + 2 * k * pi</span>
        <span class="c1"># On projector image plane:</span>
        <span class="c1"># 2*pi*f_p * stripeCentralPeak = 2*pi*f_p * u_A + phaseShift + 2*k*pi </span>
        <span class="c1"># =&gt; (self.stripeCentralPeak - u_A) * 2 * pi * f_p = theta + 2 * k * pi</span>
        <span class="c1"># =&gt;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span> <span class="o">-</span> <span class="n">u_A</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">-</span> <span class="n">theta</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># Rounding to nearest integer</span>
        
        <span class="c1"># Adjust phase using k values</span>
        <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        
        <span class="c1"># Get A and B points in pixels on imgFringe</span>
        <span class="n">Xa</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Ya</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">Xh</span> <span class="o">=</span> <span class="n">Xa</span> <span class="o">+</span> <span class="n">phaseUnwrapped</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span>
        <span class="c1"># Find y coord on epipolar line</span>
        <span class="n">Yh</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">Xh</span><span class="o">-</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">Xa</span><span class="o">-</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Ya</span><span class="o">-</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="c1"># Desidered point is H(Xh,Yh)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Xh</span><span class="p">,</span><span class="n">Yh</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="c1"># *Apply* lens distortion to H.</span>
        <span class="c1"># A projector is considered as an inversed pinhole camera (and so are</span>
        <span class="c1"># the distortion coefficients)</span>
        <span class="c1"># H is on the original imgFringe. Passing through the projector lenses,</span>
        <span class="c1"># it gets distortion, so it does not coincide with real world point.</span>
        <span class="c1"># But we want rays going exactly towards world points.</span>
        <span class="c1"># Remove intrinsic, undistort and put same intrinsic back.</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">Ap</span><span class="p">)</span>
        
        
        <span class="c1">### Triangulation</span>
        
        <span class="c1"># Build grid of indexes and apply rectification (undistorted camera points)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">widthC</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">heightC</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># Consider pixel center (see also projCoords in self._getProjectorMapping)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Apply rectification</span>
        <span class="c1"># Add ones as third coordinate</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">roi_w</span><span class="o">*</span><span class="n">roi_h</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="p">)</span>
        
        <span class="c1"># Apply rectification to projector points.</span>
        <span class="c1"># Rectify2 cancels the intrinsic and applies new rotation.</span>
        <span class="c1"># No new intrinsics here.</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Get world points</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pc</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">getBaseline</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">pc</span><span class="o">/</span><span class="n">disparity</span><span class="p">)</span>
        
        <span class="c1"># Cancel common orientation applied to first camera</span>
        <span class="c1"># to bring points into camera coordinate system</span>
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">finalPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">)</span>
        
        <span class="c1"># Reshape as original image    </span>
        <span class="k">return</span> <span class="n">finalPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_w</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span></div>
</div>

    

<div class="viewcode-block" id="StereoFTPAnaglyph">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTPAnaglyph">[docs]</a>
<span class="k">class</span> <span class="nc">StereoFTPAnaglyph</span><span class="p">(</span><span class="n">StereoFTP</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manager of the Stereo Fourier Transform Profilometry using an</span>
<span class="sd">    anaglyph pattern build with :func:`buildAnaglyphFringe`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stereoRig : StereoRig</span>
<span class="sd">        A stereo rig object with camera in position 1 (world origin) and projector in</span>
<span class="sd">        position 2.</span>
<span class="sd">    fringeDims : tuple</span>
<span class="sd">        Dimensions of projector image as (width, height).</span>
<span class="sd">    period : float</span>
<span class="sd">        Period of the fringe (in pixels).</span>
<span class="sd">    stripeColor : str, optional</span>
<span class="sd">        BGR color used for the central stripe to be chosen among &quot;blue&quot;,</span>
<span class="sd">        &quot;green&quot; or &quot;red&quot;. Also &quot;b&quot;, &quot;g&quot;, &quot;r&quot; accepted.</span>
<span class="sd">        Default to &quot;red&quot;.</span>
<span class="sd">    stripeSensitivity : float, optional</span>
<span class="sd">        Sensitivity to find the stripe. See :func:`findCentralStripe()`.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    .. note:: This is a work in progress.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="StereoFTPAnaglyph.convertGrayscale">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTPAnaglyph.convertGrayscale">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convertGrayscale</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert to grayscale using Guo et al., &quot;Improved fourier</span>
<span class="sd">        transform profilometry for the automatic measurement of 3D</span>
<span class="sd">        object shapes&quot;, 1990.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            BGR image.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Grayscale image as float.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        .. todo:: Gamma correction may be implemented as a parameter.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">img</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span></div>

        
    
<div class="viewcode-block" id="StereoFTPAnaglyph.getCloud">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTPAnaglyph.getCloud">[docs]</a>
    <span class="k">def</span> <span class="nf">getCloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">,</span> <span class="n">radius_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unwrappingMethod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an anaglyph image and get the point cloud.</span>
<span class="sd">        </span>
<span class="sd">        The pattern expected to be projected on the object is the one </span>
<span class="sd">        produced by `:func:buildAnaglyphFringe`.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imgObj : numpy.ndarray</span>
<span class="sd">            BGR image acquired by the camera.</span>
<span class="sd">        radius_factor : float, optional</span>
<span class="sd">            Radius factor of the pass-band filter. Default to 0.5.</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest in the format (x,y,width,height)</span>
<span class="sd">            where x,y is the upper left corner. Default to None.</span>
<span class="sd">        unwrappingMethod : function, optional</span>
<span class="sd">            Pointer to chosen unwrapping function. It must take the phase</span>
<span class="sd">            as the only argument. If None (default), `np.unwrap`is used.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Point cloud with shape (height,width,3), with height and width </span>
<span class="sd">        same as the input image or selected `roi`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check that is a color image</span>
        <span class="k">if</span> <span class="n">imgObj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;image must be a BGR color image!&quot;</span><span class="p">)</span>
        
        <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">res1</span> <span class="c1"># Camera resolution</span>
        
        <span class="c1"># Undistort camera image</span>
        <span class="n">imgObj</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Cut image to given roi</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
            <span class="n">imgObj</span> <span class="o">=</span> <span class="n">imgObj</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">widthC</span><span class="p">,</span><span class="n">heightC</span><span class="p">)</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
        
        <span class="c1">### Estimate camera carrier frequency fc    </span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">findCentralStripe</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeColor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeSensitivity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stripe_cam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Central stripe not found in image!&quot;</span><span class="p">)</span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">stripe_cam</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># x, y camera points (already undistorted)</span>
        
        <span class="c1"># Find integer indexes of stripe on camera (round half down)</span>
        <span class="c1">#cam_indexes = np.ceil(objStripe-0.5).astype(np.int64) # As (x,y)</span>
        <span class="c1"># Use undistorted values</span>
        <span class="n">stripe_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">stripe_cam</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="c1"># As (x,y)</span>
        
        <span class="c1">### Find world points corresponding to stripe</span>
        <span class="n">stripe_world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangulate</span><span class="p">(</span><span class="n">stripe_cam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        <span class="c1">#return stripe_world</span>
        
        <span class="c1">### Find z to build virtual reference plane</span>
        <span class="n">z_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># For each point (= for each row) estimate fc</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateCameraFrequency</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">)</span>
        
        <span class="c1">### Get projector mapping</span>
        <span class="n">projCoords</span><span class="p">,</span> <span class="n">imgR_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getProjectorMapping</span><span class="p">(</span><span class="n">z_plane</span><span class="p">)</span>
        <span class="n">imgR_gray</span> <span class="o">=</span> <span class="n">imgR_gray</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="n">projCoords</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        
        
        <span class="c1"># Preprocess image for phase analysis</span>
        <span class="c1"># following &quot; Improved fourier transform profilometry for the</span>
        <span class="c1"># automatic measurement of 3D object shapes&quot;, Guo et al. 1990</span>
        <span class="n">imgObj_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertGrayscale</span><span class="p">(</span><span class="n">imgObj</span><span class="p">)</span>
        
        <span class="c1"># FFT</span>
        <span class="n">G0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgR_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># FFT on x dimension</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgObj_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">roi_w</span><span class="p">)</span>

        <span class="c1"># Pass-band filter parameters</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius_factor</span><span class="o">*</span><span class="n">fc</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">radius</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">radius</span>
        
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Virtual reference&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Object&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Virtual reference&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">imgR_gray</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">imgR_gray</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">imgR_gray</span><span class="p">))</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Object&quot;</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press a key over the images to continue...&quot;</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
            
            <span class="c1"># Get discrete indexes of frequencies</span>
            <span class="n">fIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fminIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fmaxIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmax</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Middle row FFT module&quot;</span><span class="p">)</span>
            <span class="c1"># Show module of FFTs</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G0</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G0|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="c1"># Show filtered band</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fminIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fmaxIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fc=</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>    
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Phase filtering</span>
        <span class="n">mask_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmin</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G0</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G0</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Inverse FFT</span>
        <span class="n">g0hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Build the new signal and get its phase</span>
        <span class="c1"># NB Numerically this is not equivalent to the phase difference.</span>
        <span class="c1"># https://stackoverflow.com/questions/69176709/numerical-differences-in-numpy-conjugate-and-angle/69178618#69178618</span>
        <span class="n">newSignal</span> <span class="o">=</span> <span class="n">ghat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">g0hat</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">newSignal</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">unwrappingMethod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unwrap along the direction perpendicular to the fringe</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">discont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># And remove jumps along other direction</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">phaseUnwrapped</span><span class="p">,</span> <span class="n">discont</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">unwrappingMethod</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
              
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Middle row unwrapped phase&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">phase</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Phase shift&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">phaseUnwrapped</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unwrapped phase shift&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel position&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1">### Lazy shortcut for many values</span>
        <span class="n">Ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span>
        <span class="n">Dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span>
        
        <span class="n">Ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">R</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ep</span>
        
        <span class="c1">### Find k values from central stripe</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        # Calculate absolute phase shift [S. Zhang 2006 Novel method...]</span>
<span class="sd">        theta_shift = phaseUnwrapped[cam_indexes[:,1],cam_indexes[:,0]]</span>
<span class="sd">        theta_shift = np.mean(theta_shift)</span>
<span class="sd">        phaseUnwrapped = phaseUnwrapped - theta_shift</span>
<span class="sd">        phaseUnwrapped = phaseUnwrapped.reshape(-1,1)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># Alternative and more accurate method: we know k is an integer!</span>
        <span class="c1"># Finding and rounding k we reduce numerical errors.</span>
        
        <span class="n">theta</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span><span class="p">[</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># Phase values at stripe locations</span>
        <span class="n">u_A</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">stripe_indexes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]][:,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Stripe over reference as seen from projector </span>
        <span class="c1"># absolutePhase = knownPhase + phaseShift + 2 * k * pi</span>
        <span class="c1"># On projector image plane:</span>
        <span class="c1"># 2*pi*f_p * stripeCentralPeak = 2*pi*f_p * u_A + phaseShift + 2*k*pi </span>
        <span class="c1"># =&gt; (self.stripeCentralPeak - u_A) * 2 * pi * f_p = theta + 2 * k * pi</span>
        <span class="c1"># =&gt;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span> <span class="o">-</span> <span class="n">u_A</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">-</span> <span class="n">theta</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># Rounding to nearest integer</span>
        
        <span class="c1"># Adjust phase using k values</span>
        <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        
        <span class="c1"># Get A and B points in pixels on imgFringe</span>
        <span class="n">Xa</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Ya</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">Xh</span> <span class="o">=</span> <span class="n">Xa</span> <span class="o">+</span> <span class="n">phaseUnwrapped</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span>
        <span class="c1"># Find y coord on epipolar line</span>
        <span class="n">Yh</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">Xh</span><span class="o">-</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">Xa</span><span class="o">-</span><span class="n">ep</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Ya</span><span class="o">-</span><span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">ep</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="c1"># Desidered point is H(Xh,Yh)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Xh</span><span class="p">,</span><span class="n">Yh</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="c1"># *Apply* lens distortion to H.</span>
        <span class="c1"># A projector is considered as an inversed pinhole camera (and so are</span>
        <span class="c1"># the distortion coefficients)</span>
        <span class="c1"># H is on the original imgFringe. Passing through the projector lenses,</span>
        <span class="c1"># it gets distortion, so it does not coincide with real world point.</span>
        <span class="c1"># But we want rays going exactly towards world points.</span>
        <span class="c1"># Remove intrinsic, undistort and put same intrinsic back.</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">Ap</span><span class="p">)</span>
        
        
        <span class="c1">### Triangulation</span>
        
        <span class="c1"># Build grid of indexes and apply rectification (undistorted camera points)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">widthC</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">heightC</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># Consider pixel center (see also projCoords in self._getProjectorMapping)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Apply rectification</span>
        <span class="c1"># Add ones as third coordinate</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">roi_w</span><span class="o">*</span><span class="n">roi_h</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="p">)</span>
        
        <span class="c1"># Apply rectification to projector points.</span>
        <span class="c1"># Rectify2 cancels the intrinsic and applies new rotation.</span>
        <span class="c1"># No new intrinsics here.</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Get world points</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pc</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">getBaseline</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">pc</span><span class="o">/</span><span class="n">disparity</span><span class="p">)</span>
        
        <span class="c1"># Cancel common orientation applied to first camera</span>
        <span class="c1"># to bring points into camera coordinate system</span>
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">finalPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">)</span>
        
        <span class="c1"># Reshape as original image    </span>
        <span class="k">return</span> <span class="n">finalPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_w</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="GrayCode">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.GrayCode">[docs]</a>
<span class="k">class</span> <span class="nc">GrayCode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for the Gray code method from OpenCV.</span>
<span class="sd">    </span>
<span class="sd">    Structured-light implementation using camera-projector</span>
<span class="sd">    calibrated rig.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rig : StereoRig</span>
<span class="sd">        A stereo rig object with camera in position 1 (world origin) and projector in</span>
<span class="sd">        position 2.</span>
<span class="sd">    black_thr : int, optional</span>
<span class="sd">       Black threshold is a number between 0-255 that represents the</span>
<span class="sd">       minimum brightness difference required for valid pixels, between</span>
<span class="sd">       the fully illuminated (white) and the not illuminated images</span>
<span class="sd">       (black); used in computeShadowMasks method. Default to 40.</span>
<span class="sd">    white_thr : int, optional</span>
<span class="sd">        White threshold is a number between 0-255 that represents the</span>
<span class="sd">        minimum brightness difference required for valid pixels, between</span>
<span class="sd">        the graycode pattern and its inverse images; used in </span>
<span class="sd">        `getProjPixel` method. Default to 5.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">        Projector distortion may be unaccurate, especially along border.</span>
<span class="sd">        If this is the case, you can ignore it setting</span>
<span class="sd">        `rig.distCoeffs2 == None` before passing `rig` to the constructor</span>
<span class="sd">        or setting a narrow `roi`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rig</span><span class="p">,</span> <span class="n">black_thr</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">white_thr</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rig</span> <span class="o">=</span> <span class="n">rig</span>
        <span class="c1"># Build graycode using projector resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">structured_light_GrayCodePattern</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">rig</span><span class="o">.</span><span class="n">res2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rig</span><span class="o">.</span><span class="n">res2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">setBlackThreshold</span><span class="p">(</span><span class="n">black_thr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">setWhiteThreshold</span><span class="p">(</span><span class="n">white_thr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">getNumberOfPatternImages</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">,</span> <span class="n">commonRotation</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">rectification</span><span class="o">.</span><span class="n">_lowLevelRectify</span><span class="p">(</span><span class="n">rig</span><span class="p">)</span>
        <span class="c1"># Get inverse common orientation and extend to 4x4 transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">commonRotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
        
<div class="viewcode-block" id="GrayCode.getCloud">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.GrayCode.getCloud">[docs]</a>
    <span class="k">def</span> <span class="nf">getCloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the 3D point calculation from a list of images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        images : list or tuple       </span>
<span class="sd">            A list of image *paths* acquired by the camera.</span>
<span class="sd">            Each set must be ordered like all the Gray code patterns</span>
<span class="sd">            (see `cv2.structured_light_GrayCodePattern`).</span>
<span class="sd">            Any following extra image will be ignored (es. full white).</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest in the format (x,y,width,height)</span>
<span class="sd">            where x,y is the upper left corner. Default to None.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Points with shape (n,1,3)</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        .. todo::</span>
<span class="sd">           Add possibility to return point cloud in same image/roi</span>
<span class="sd">           shape with NaN in invalid locations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">res1</span> <span class="c1"># Camera resolution</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Load images</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">images</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_patterns</span><span class="p">]:</span> <span class="c1"># Exclude any extra images (es. white, black)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">heightC</span><span class="p">,</span><span class="n">widthC</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image size of </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> is mismatch!&#39;</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">)</span>
            <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        
        <span class="n">pc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roi_x</span><span class="p">,</span><span class="n">roi_y</span><span class="p">,</span><span class="n">roi_w</span><span class="p">,</span><span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi_x</span><span class="p">,</span><span class="n">roi_y</span><span class="p">,</span><span class="n">roi_w</span><span class="p">,</span><span class="n">roi_h</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span><span class="p">)</span>
            
        <span class="c1"># Find corresponding points</span>
        <span class="c1"># Since we are jumping some points, there is no correspondence</span>
        <span class="c1"># with any BGR image used for color in the final PLY file.</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roi_y</span><span class="p">,</span><span class="n">roi_h</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roi_x</span><span class="p">,</span><span class="n">roi_w</span><span class="p">):</span>
                <span class="n">err</span><span class="p">,</span> <span class="n">proj_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">getProjPixel</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">pp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proj_pix</span><span class="p">)</span>
                    <span class="n">pc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        
        <span class="c1"># Now we have solved the stereo correspondence problem.</span>
        <span class="c1"># To do triangulation easily, it is better to rectify.</span>
        
        <span class="c1"># Convert</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Consider pixel center (negligible difference, anyway...)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">+</span> <span class="mf">0.5</span>
        
        <span class="c1"># *Apply* lens distortion to pp.</span>
        <span class="c1"># A projector is considered as an inversed pinhole camera (and so are</span>
        <span class="c1"># the distortion coefficients)</span>
        <span class="c1"># H is on the original imgFringe. Passing through the projector lenses,</span>
        <span class="c1"># it gets distortion, so it does not coincide with real world point.</span>
        <span class="c1"># But we want points to be an exact projection of the world points.</span>
        <span class="c1"># Remove intrinsic, undistort and put same intrinsic back.</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">distCoeffs2</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">)</span>
        
        <span class="c1"># Apply rectification</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Add ones as third coordinate</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">pc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="p">)</span>
        
        <span class="c1"># Get world points</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pc</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">getBaseline</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">pc</span><span class="o">/</span><span class="n">disparity</span><span class="p">)</span>
        
        <span class="c1"># Cancel common orientation applied to first camera</span>
        <span class="c1"># to bring points into camera coordinate system</span>
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">finalPoints</span></div>
</div>

    
    
<div class="viewcode-block" id="StereoFTP_Mapping">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP_Mapping">[docs]</a>
<span class="k">class</span> <span class="nc">StereoFTP_Mapping</span><span class="p">(</span><span class="n">StereoFTP</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manager of the classic Stereo Fourier Transform Profilometry.</span>
<span class="sd">    </span>
<span class="sd">    Classic method (does not use a virtual reference plane) but it does</span>
<span class="sd">    use the automatic band-pass estimation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stereoRig : StereoRig</span>
<span class="sd">        A stereo rig object with camera in position 1 (world origin) and projector in</span>
<span class="sd">        position 2.</span>
<span class="sd">    fringeDims : tuple</span>
<span class="sd">        Dimensions of projector image as (width, height).</span>
<span class="sd">    period : float</span>
<span class="sd">        Period of the fringe (in pixels).</span>
<span class="sd">    stripeColor : str, optional</span>
<span class="sd">        BGR color used for the central stripe to be chosen among &quot;blue&quot;,</span>
<span class="sd">        &quot;green&quot; or &quot;red&quot;. Also &quot;b&quot;, &quot;g&quot;, &quot;r&quot; accepted.</span>
<span class="sd">        Default to &quot;red&quot;.</span>
<span class="sd">    stripeSensitivity : float, optional</span>
<span class="sd">        Sensitivity to find the stripe. See :func:`findCentralStripe()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
<div class="viewcode-block" id="StereoFTP_Mapping.getCloud">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP_Mapping.getCloud">[docs]</a>
    <span class="k">def</span> <span class="nf">getCloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">,</span> <span class="n">radius_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unwrappingMethod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an image and get the point cloud.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imgObj : numpy.ndarray</span>
<span class="sd">            BGR image acquired by the camera.</span>
<span class="sd">        radius_factor : float, optional</span>
<span class="sd">            Radius factor of the pass-band filter. Default to 0.5.</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest in the format (x,y,width,height)</span>
<span class="sd">            where x,y is the upper left corner. Default to None.</span>
<span class="sd">        unwrappingMethod : function, optional</span>
<span class="sd">            Pointer to chosen unwrapping function. It must take the phase</span>
<span class="sd">            as the only argument. If None (default), `np.unwrap`is used.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Point cloud with shape (height,width,3), with height and width </span>
<span class="sd">        same as the input image or selected `roi`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check that is a color image</span>
        <span class="k">if</span> <span class="n">imgObj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;image must be a BGR color image!&quot;</span><span class="p">)</span>
        
        <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">res1</span> <span class="c1"># Camera resolution</span>
        
        <span class="c1"># Undistort camera image</span>
        <span class="n">imgObj</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Cut image to given roi</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
            <span class="n">imgObj</span> <span class="o">=</span> <span class="n">imgObj</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">widthC</span><span class="p">,</span><span class="n">heightC</span><span class="p">)</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
        
        <span class="c1">### Estimate camera carrier frequency fc    </span>
        <span class="c1"># Find central stripe on camera image</span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">findCentralStripe</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">stripeColor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeSensitivity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stripe_cam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Central stripe not found in image!&quot;</span><span class="p">)</span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">stripe_cam</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># x, y camera points (already undistorted)</span>
        
        <span class="c1"># Find integer indexes of stripe on camera (round half down)</span>
        <span class="c1">#cam_indexes = np.ceil(objStripe-0.5).astype(np.int64) # As (x,y)</span>
        
        
        <span class="c1">### Find world points corresponding to stripe</span>
        <span class="n">stripe_world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangulate</span><span class="p">(</span><span class="n">stripe_cam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        <span class="c1">#return stripe_world</span>
        
        <span class="c1">### Build virtual reference plane</span>
        <span class="c1">#z_plane = np.min(stripe_world[:,2])</span>
        
        <span class="c1"># For each camera stripe point (= for each row) estimate fc</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateCameraFrequency</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">)</span>
        
        <span class="c1"># Preprocess image for phase analysis</span>
        <span class="n">imgObj_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertGrayscale</span><span class="p">(</span><span class="n">imgObj</span><span class="p">)</span>
        
        <span class="c1"># FFT</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgObj_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">roi_w</span><span class="p">)</span>
        
        <span class="c1"># Pass-band filter parameters</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius_factor</span><span class="o">*</span><span class="n">fc</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">radius</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">radius</span>
        
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Object&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Object&quot;</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press a key over the images to continue...&quot;</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
            
            <span class="c1"># Get discrete indexes of frequencies</span>
            <span class="c1">#fIndex = np.argmin( np.abs(freqs.reshape(1,-1) - fc.reshape(-1,1)), axis=1 ) # Shape (roi_h, )</span>
            <span class="c1">#fminIndex = np.argmin( np.abs(freqs.reshape(1,-1) - fmin.reshape(-1,1)), axis=1 ) # Shape (roi_h, )</span>
            <span class="c1">#fmaxIndex = np.argmin( np.abs(freqs.reshape(1,-1) - fmax.reshape(-1,1)), axis=1 ) # Shape (roi_h, )</span>
            <span class="n">fIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fminIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fmaxIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmax</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Middle row FFT module&quot;</span><span class="p">)</span>
            <span class="c1"># Show module of FFTs</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="c1"># Show filtered band</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fminIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fmaxIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fc=</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>    
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Phase filtering</span>
        <span class="n">mask_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmin</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Inverse FFT</span>
        <span class="n">ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">ghat</span><span class="p">)</span> <span class="c1"># (-pi, pi]</span>
        
        
        <span class="k">if</span> <span class="n">unwrappingMethod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unwrap along the direction perpendicular to the fringe</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># And remove jumps along other direction</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">phaseUnwrapped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">unwrappingMethod</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
              
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Middle row unwrapped phase&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">phase</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Phase&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">phaseUnwrapped</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Unwrapped phase&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Pixel position&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        
        <span class="c1"># Calculate absolute phase shift [S. Zhang 2006 Novel method...]</span>
        
        <span class="c1"># ALTERNATIVE</span>
        <span class="c1">#stripe_indexes = np.ceil(stripe_cam-0.5).astype(np.int64) # As (x,y)</span>
        <span class="c1">#theta_shift = phaseUnwrapped[stripe_indexes[:,1],stripe_indexes[:,0]]</span>
        <span class="c1"># Interpolation of phase values</span>
        
        <span class="c1"># Coordinates as [[list of y values...],[list of x values...]]</span>
        <span class="n">theta_shift</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span><span class="n">phaseUnwrapped</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">stripe_cam</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">theta_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">theta_shift</span><span class="p">)</span>
        
        <span class="c1"># Adjust phase to get absolute phase</span>
        <span class="c1"># Consider stripe as phase zero</span>
        <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span> <span class="o">-</span> <span class="n">theta_shift</span>
        <span class="n">phaseUnwrapped</span> <span class="o">=</span> <span class="n">phaseUnwrapped</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        
        <span class="c1"># Corresponding projector x values (add bias stripe + pixel center)</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">phaseUnwrapped</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span> <span class="o">+</span> <span class="mf">0.5</span>
        
        <span class="c1"># Camera coordinates</span>
        <span class="n">camPoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">roi_w</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">roi_h</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">camPoints</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="c1"># Consider pixel center</span>
        
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangulate</span><span class="p">(</span><span class="n">camPoints</span><span class="p">,</span> <span class="n">p_x</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        
        <span class="c1"># Reshape as original image    </span>
        <span class="k">return</span> <span class="n">finalPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_w</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span></div>
</div>








        

<span class="c1"># Alias for single camera version</span>
<span class="n">GrayCodeSingle</span> <span class="o">=</span> <span class="n">GrayCode</span>

<div class="viewcode-block" id="GrayCodeDouble">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.GrayCodeDouble">[docs]</a>
<span class="k">class</span> <span class="nc">GrayCodeDouble</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for the Gray code method from OpenCV.</span>
<span class="sd">    </span>
<span class="sd">    Conventional active stereo implementation, i.e. using two calibrated cameras and</span>
<span class="sd">    one uncalibrated projector.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rig : StereoRig</span>
<span class="sd">        A stereo rig object with two cameras.</span>
<span class="sd">    projRes : tuple</span>
<span class="sd">        Projector resolution as (width, height).</span>
<span class="sd">    black_thr : int, optional</span>
<span class="sd">       Black threshold is a number between 0-255 that represents the</span>
<span class="sd">       minimum brightness difference required for valid pixels, between</span>
<span class="sd">       the fully illuminated (white) and the not illuminated images</span>
<span class="sd">       (black); used in computeShadowMasks method. Default to 40.</span>
<span class="sd">    white_thr : int, optional</span>
<span class="sd">        White threshold is a number between 0-255 that represents the</span>
<span class="sd">        minimum brightness difference required for valid pixels, between</span>
<span class="sd">        the graycode pattern and its inverse images; used in </span>
<span class="sd">        `getProjPixel` method. Default to 5.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    .. todo::</span>
<span class="sd">        Projector distortion may be unaccurate, especially along border.</span>
<span class="sd">        If this is the case, you can ignore it setting</span>
<span class="sd">        `rig.distCoeffs2 == None` before passing `rig` to the constructor</span>
<span class="sd">        or setting a narrow `roi`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rig</span><span class="p">,</span> <span class="n">projRes</span><span class="p">,</span> <span class="n">black_thr</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">white_thr</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rig</span> <span class="o">=</span> <span class="n">rig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projRes</span> <span class="o">=</span> <span class="n">projRes</span>
        <span class="c1"># Build graycode using projector resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">structured_light_GrayCodePattern</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">projRes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">projRes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">setBlackThreshold</span><span class="p">(</span><span class="n">black_thr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">setWhiteThreshold</span><span class="p">(</span><span class="n">white_thr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">getNumberOfPatternImages</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">,</span> <span class="n">commonRotation</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">rectification</span><span class="o">.</span><span class="n">_lowLevelRectify</span><span class="p">(</span><span class="n">rig</span><span class="p">)</span>
        <span class="c1">### Get inverse common orientation and extend to 4x4 transform</span>
        <span class="c1">#self.R_inv = np.linalg.inv(commonRotation)</span>
        <span class="c1">#self.R_inv = np.hstack( ( np.vstack( (self.R_inv,np.zeros((1,3))) ), np.zeros((4,1)) ) )</span>
        <span class="c1">#self.R_inv[3,3] = 1</span>
        
<div class="viewcode-block" id="GrayCodeDouble.getCloud">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.GrayCodeDouble.getCloud">[docs]</a>
    <span class="k">def</span> <span class="nf">getCloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">roi1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roi2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the 3D point calculation from a list of images.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        images : list or tuple       </span>
<span class="sd">            A list (or tuple) of 2 dimensional tuples (ordered left and</span>
<span class="sd">            right) of image paths, e.g. [(&quot;oneL.png&quot;,&quot;oneR.png&quot;),</span>
<span class="sd">            (&quot;twoL.png&quot;,&quot;twoR.png&quot;), ...]</span>
<span class="sd">            Each set must be ordered like all the Gray code patterns</span>
<span class="sd">            (see `cv2.structured_light_GrayCodePattern`).</span>
<span class="sd">            Any following extra image will be ignored (es. full white).</span>
<span class="sd">        roi1 : tuple, optional</span>
<span class="sd">            Region of interest on camera 1 in the format</span>
<span class="sd">            (x,y,width,height) where x,y is the upper left corner.</span>
<span class="sd">            Default to None.</span>
<span class="sd">        roi2 : tuple, optional</span>
<span class="sd">            As `roi1`, but for camera 2.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Points with shape (n,1,3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">res1</span> <span class="c1"># Camera 1 resolution</span>
        <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">res2</span> <span class="c1"># Camera 1 resolution</span>
        <span class="c1"># Contains at proj indexes, both camera correspondences as (x1,y1,x2,y2)</span>
        <span class="n">corresp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">projRes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">projRes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intp</span><span class="p">)</span>
        
        <span class="c1"># Load images</span>
        <span class="n">imgs1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">imgs2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname1</span><span class="p">,</span> <span class="n">fname2</span> <span class="ow">in</span> <span class="n">images</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_patterns</span><span class="p">]:</span> <span class="c1"># Exclude any extra images (es. white, black)</span>
            <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h1</span><span class="p">,</span><span class="n">w1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image size of </span><span class="si">{</span><span class="n">fname1</span><span class="si">}</span><span class="s1"> is mismatch!&#39;</span><span class="p">)</span>
            <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img2</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">h2</span><span class="p">,</span><span class="n">w2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Image size of </span><span class="si">{</span><span class="n">fname2</span><span class="si">}</span><span class="s1"> is mismatch!&#39;</span><span class="p">)</span>
            <span class="n">img1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">)</span>
            <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">distCoeffs2</span><span class="p">)</span>
            <span class="n">imgs1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
            <span class="n">imgs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">roi1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roi1_x</span><span class="p">,</span><span class="n">roi1_y</span><span class="p">,</span><span class="n">roi1_w</span><span class="p">,</span><span class="n">roi1_h</span> <span class="o">=</span> <span class="n">roi1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi1_x</span><span class="p">,</span><span class="n">roi1_y</span><span class="p">,</span><span class="n">roi1_w</span><span class="p">,</span><span class="n">roi1_h</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span><span class="p">)</span>
            
        <span class="c1"># Find corresponding points</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roi1_y</span><span class="p">,</span><span class="n">roi1_h</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roi1_x</span><span class="p">,</span><span class="n">roi1_w</span><span class="p">):</span>
                <span class="n">err</span><span class="p">,</span> <span class="n">proj_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">getProjPixel</span><span class="p">(</span><span class="n">imgs1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">corresp</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">corresp</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">roi2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">roi2_x</span><span class="p">,</span><span class="n">roi2_y</span><span class="p">,</span><span class="n">roi2_w</span><span class="p">,</span><span class="n">roi2_h</span> <span class="o">=</span> <span class="n">roi2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi2_x</span><span class="p">,</span><span class="n">roi2_y</span><span class="p">,</span><span class="n">roi2_w</span><span class="p">,</span><span class="n">roi2_h</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">h2</span><span class="p">)</span>
            
        <span class="c1"># Find corresponding points</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roi2_y</span><span class="p">,</span><span class="n">roi2_h</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">roi2_x</span><span class="p">,</span><span class="n">roi2_w</span><span class="p">):</span>
                <span class="n">err</span><span class="p">,</span> <span class="n">proj_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graycode</span><span class="o">.</span><span class="n">getProjPixel</span><span class="p">(</span><span class="n">imgs2</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">corresp</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">corresp</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Filter out missing correspondences</span>
        <span class="n">corresp</span> <span class="o">=</span> <span class="n">corresp</span><span class="p">[(</span><span class="n">corresp</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
        
        <span class="c1"># Consider pixel center (negligible difference, anyway...)</span>
        <span class="n">corresp</span> <span class="o">+=</span> <span class="mf">0.5</span>
        
        
        <span class="c1"># Now we have solved the stereo correspondence problem.</span>
        <span class="c1"># To do triangulation easily, it is better to rectify.</span>
        
        <span class="c1"># Convert</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">corresp</span><span class="p">[:,:,:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">corresp</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Apply rectification</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Add ones as third coordinate</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">p1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="p">)</span>
        
        <span class="c1"># Get world points</span>
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p1</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rig</span><span class="o">.</span><span class="n">getBaseline</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="o">/</span><span class="n">disparity</span><span class="p">)</span>
        
        <span class="c1"># Cancel common orientation applied to first camera</span>
        <span class="c1"># to bring points into camera coordinate system</span>
        <span class="n">finalPoints</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">finalPoints</span></div>
</div>



<div class="viewcode-block" id="computeROI">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.computeROI">[docs]</a>
<span class="k">def</span> <span class="nf">computeROI</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">blackThreshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">extraMargin</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exclude black regions along borders.</span>
<span class="sd">    </span>
<span class="sd">    Usually the projector does not illuminate the whole image area.</span>
<span class="sd">    This function attempts to find the region of interest as a rectangle</span>
<span class="sd">    inside the biggest contour.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : numpy.ndarray</span>
<span class="sd">        Camera image with black borders.</span>
<span class="sd">    blackThreshold : int, optional</span>
<span class="sd">        Threshold for the black regions between 0 and 255.</span>
<span class="sd">        Default to 10.</span>
<span class="sd">    extraMargin : int, optional</span>
<span class="sd">        Extra safety margin to reduce to ROI. Default to 0.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        ROI as tuple of integers (x,y,w,h).</span>
<span class="sd">    </span>
<span class="sd">    .. note:: To rewrite completely. Not suitable for production. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    
    <span class="n">height</span><span class="p">,</span><span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">img_thresh</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">blackThreshold</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
    <span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">img_thresh</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
    <span class="c1"># Select biggest contour</span>
    <span class="n">best_cnt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">)</span>
    <span class="c1"># Find bounding rectangle</span>
    <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">best_cnt</span><span class="p">)</span>
    
    <span class="c1"># Look around rect borders and start shinking until is all inside</span>
    <span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span>
    <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">allInside</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># TOP</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x2</span><span class="o">+</span><span class="n">w2</span><span class="p">):</span>
            <span class="c1"># Check that all the row in inside the contour.</span>
            <span class="k">if</span> <span class="n">y2</span> <span class="o">&gt;=</span> <span class="n">height</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">pointPolygonTest</span><span class="p">(</span><span class="n">best_cnt</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># Point is outside</span>
                <span class="n">y2</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">allInside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="c1"># RIGHT</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">y2</span><span class="o">+</span><span class="n">h2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">w2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">pointPolygonTest</span><span class="p">(</span><span class="n">best_cnt</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="o">+</span><span class="n">w2</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">w2</span><span class="o">-=</span><span class="mi">1</span>
                <span class="n">allInside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="c1"># BOTTOM</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">x2</span><span class="o">+</span><span class="n">w2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">h2</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">pointPolygonTest</span><span class="p">(</span><span class="n">best_cnt</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">y2</span><span class="o">+</span><span class="n">h2</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">h2</span><span class="o">-=</span><span class="mi">1</span>
                <span class="n">allInside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="c1"># LEFT</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span><span class="n">y2</span><span class="o">+</span><span class="n">h2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x2</span> <span class="o">&gt;=</span> <span class="n">width</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">pointPolygonTest</span><span class="p">(</span><span class="n">best_cnt</span><span class="p">,</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">x2</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">allInside</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">allInside</span><span class="p">:</span> <span class="c1"># all the rect borders are within the contour</span>
            <span class="k">break</span>
    
    
    <span class="c1"># Reduce ROI further.</span>
    <span class="n">x2</span> <span class="o">+=</span> <span class="n">extraMargin</span>
    <span class="n">y2</span> <span class="o">+=</span> <span class="n">extraMargin</span>
    <span class="n">w2</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">extraMargin</span><span class="p">)</span>
    <span class="n">h2</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">extraMargin</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="n">h2</span><span class="p">)</span></div>





<span class="c1">########################################################################</span>
<span class="c1">### TEMP FOR EXPERIMENTS</span>
<span class="c1">### Return phase shift and phase of object only (NO 3D)</span>
<div class="viewcode-block" id="StereoFTP_PhaseOnly">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP_PhaseOnly">[docs]</a>
<span class="k">class</span> <span class="nc">StereoFTP_PhaseOnly</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manager of the Stereo Fourier Transform Profilometry.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stereoRig : StereoRig</span>
<span class="sd">        A stereo rig object with camera in position 1 (world origin) and projector in</span>
<span class="sd">        position 2.</span>
<span class="sd">    fringeDims : tuple</span>
<span class="sd">        Dimensions of projector image as (width, height).</span>
<span class="sd">    period : float</span>
<span class="sd">        Period of the fringe (in pixels).</span>
<span class="sd">    stripeColor : str, optional</span>
<span class="sd">        BGR color used for the central stripe to be chosen among &quot;blue&quot;,</span>
<span class="sd">        &quot;green&quot; or &quot;red&quot;. Also &quot;b&quot;, &quot;g&quot;, &quot;r&quot; accepted.</span>
<span class="sd">        Default to &quot;red&quot;.</span>
<span class="sd">    stripeSensitivity : float, optional</span>
<span class="sd">        Sensitivity to find the stripe. See :func:`findCentralStripe()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stereoRig</span><span class="p">,</span> <span class="n">fringe</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">stripeColor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">stripeSensitivity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span> <span class="o">=</span> <span class="n">stereoRig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fringe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertGrayscale</span><span class="p">(</span><span class="n">fringe</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fringeDims</span> <span class="o">=</span> <span class="n">fringe</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (width, height)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripeColor</span> <span class="o">=</span> <span class="n">stripeColor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripeSensitivity</span> <span class="o">=</span> <span class="n">stripeSensitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span> <span class="o">=</span> <span class="n">_getCentralPeak</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fringeDims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">period</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">getFundamentalMatrix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">,</span> <span class="n">commonR</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">rectification</span><span class="o">.</span><span class="n">_lowLevelRectify</span><span class="p">(</span><span class="n">stereoRig</span><span class="p">)</span>
        
        <span class="c1">### Get epipole on projector</span>
        <span class="c1"># Project camera position (0,0,0) onto projector image plane.</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span><span class="o">/</span><span class="n">ep</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1">### Get inverse common orientation and extend to 4x4 transform</span>
        <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">commonR</span><span class="p">)</span>
        <span class="n">R_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">R_inv</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">R_inv</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span> <span class="o">=</span> <span class="n">R_inv</span>
        
    
<div class="viewcode-block" id="StereoFTP_PhaseOnly.convertGrayscale">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP_PhaseOnly.convertGrayscale">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convertGrayscale</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert to grayscale using max.</span>
<span class="sd">        </span>
<span class="sd">        This keeps highest BGR value over the central stripe</span>
<span class="sd">        (e.g. (0,0,255) -&gt; 255), allowing the FFT to work properly.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image : numpy.ndarray</span>
<span class="sd">            BGR image.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Grayscale image.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        .. todo:: Gamma correction may be implemented as a parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

    
    
    <span class="k">def</span> <span class="nf">_getProjectorMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find projector image points corresponding to each camera pixel</span>
<span class="sd">        after projection on reference plane to build coordinates and</span>
<span class="sd">        virtual reference image (as seen from camera)</span>
<span class="sd">        </span>
<span class="sd">        Points are processed and returned in row-major order.</span>
<span class="sd">        The center of each pixel is considered as point.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        z : float</span>
<span class="sd">            Desidered distance of the reference plane from the camera.</span>
<span class="sd">        interpolation : int</span>
<span class="sd">            See OpenCV interpolation constants. Default to `cv2.INTER_CUBIC`.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Matrix of points with same width and height of camera resolution.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Corresponding points on reference plane do not vary. They have to</span>
<span class="sd">        be calculated only during initialization considering the chosen </span>
<span class="sd">        reference plane.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">res1</span>
        <span class="n">invAc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">)</span>
        
        <span class="c1"># Build grid of x,y coordinates</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">w</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># Consider center of pixel: it can be thought as</span>
        <span class="c1"># the center of the light beam entering the camera</span>
        <span class="c1"># Experiments showed that this is needed for projCoords</span>
        <span class="c1"># but *not* for the virtual reference image</span>
        <span class="c1"># (depends on how cv2.remap works, integer indexes</span>
        <span class="c1"># of original images are used)</span>
        <span class="n">doubleGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">grid</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">grid</span><span class="p">))</span>
        <span class="n">doubleGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doubleGrid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">w</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># For *both* grids</span>
        <span class="c1"># de-project from camera to reference plane</span>
        <span class="c1"># and project on projector&#39;s image plane.</span>
        
        <span class="c1"># 1st half: To get exact projector coordinates from camera x,y coordinates (center of pixel)</span>
        <span class="c1"># 2d half: To build a virtual reference image (using *integer* pixel coordinates)</span>
        <span class="n">pp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">doubleGrid</span><span class="p">,</span>
            <span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invAc</span><span class="p">),</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span><span class="p">)</span>
        
        <span class="c1"># Separate the two grids</span>
        <span class="n">pointsA</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="n">h</span><span class="o">*</span><span class="n">w</span><span class="p">:]</span>                   <span class="c1"># 1st half</span>
        <span class="n">projCoords</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[:</span><span class="n">h</span><span class="o">*</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 2nd half</span>
        
        <span class="n">mapx</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pointsA</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">mapy</span> <span class="o">=</span> <span class="p">(</span> <span class="n">pointsA</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="n">virtualReferenceImg</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">remap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fringe</span><span class="p">,</span> <span class="n">mapx</span><span class="p">,</span> <span class="n">mapy</span><span class="p">,</span> <span class="n">interpolation</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="n">projCoords</span><span class="p">,</span> <span class="n">virtualReferenceImg</span>
    
    
    <span class="k">def</span> <span class="nf">_calculateCameraFrequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objPoints</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate fc from system geometry, fp and object points value.</span>
<span class="sd">        </span>
<span class="sd">        Draw a plane at given z distance in front of the camera.</span>
<span class="sd">        Find period size on it and project that size on camera.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span>
        <span class="n">Dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span>
        
        <span class="n">Ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">R</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span>
        
        <span class="n">Op</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="c1">#ObjCenter = np.array([[[0],[0],[z]]], dtype=np.float32)</span>
        <span class="n">objPoints</span> <span class="o">=</span> <span class="n">objPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">objPoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Send center of reference plane to projector</span>
        <span class="n">pCenter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">objPoints</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span><span class="p">)</span>
        <span class="c1"># Now we are in the projected image</span>
        <span class="c1"># Perfect fringe pattern. No distortion</span>
        
        <span class="c1"># Find two points at distance Tp (period on projector)</span>
        <span class="n">halfPeriodP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        
        <span class="n">leftX</span> <span class="o">=</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">halfPeriodP</span>
        <span class="n">rightX</span> <span class="o">=</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">halfPeriodP</span>
        
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">leftX</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rightX</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">pCenter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Shape (2n, 1, 2)</span>
        
        <span class="c1">### Deproject on world plane</span>
        <span class="c1"># Un-distort points for the projector means to distort</span>
        <span class="c1"># as the pinhole camera model is made for cameras</span>
        <span class="c1"># and we are projecting back to 3D world</span>
        <span class="n">distortedPoints</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">Ap</span><span class="p">)</span> <span class="c1"># Shape (2n, 1, 2)</span>
        
        <span class="c1"># De-project in homogeneous coordinates at known world z</span>
        <span class="c1"># s * pp = Ap[R | T] * [pw 1].T</span>
        <span class="n">invARp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Ap</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">distortedPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">objPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="c1"># Shape (2n, 3)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">objPoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># Shape (2n, 1)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">invARp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="c1"># Shape (2n, 3)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">Op</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">h</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">]]</span> <span class="c1"># Shape (2n, )</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">Op</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># Project on camera image plane (also applying lens distortion).</span>
        <span class="c1"># b points are seen by the camera (from world origin)</span>
        <span class="n">pc</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">projectPoints</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">Ac</span><span class="p">,</span> <span class="n">Dc</span><span class="p">)</span> <span class="c1"># Shape (2n, 1, 2)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
        <span class="c1"># Now we have couples of 2 points on the camera that differ</span>
        <span class="c1"># exactly one projector period from each other</span>
        <span class="c1"># as seen by the camera</span>
        <span class="c1"># Use the first Euclid theorem to get the effective period</span>
        <span class="n">Tc</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Return frequency</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">Tc</span>    
    
    <span class="k">def</span> <span class="nf">_triangulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camPoints</span><span class="p">,</span> <span class="n">p_x</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each camera undistorted point (c_x, c_y) and corresponding </span>
<span class="sd">        projector x-value p_x, find 3D point using Fundamental matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">camPoints</span> <span class="o">=</span> <span class="n">camPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">camPoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">camPoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Add coordinate x shift</span>
        <span class="n">camPoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Add coordinate y shift</span>
        
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">camPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">epipolarLinesP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">camPoints</span><span class="p">,</span> <span class="n">ones</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1"># Shape (n, 3)</span>
        
        <span class="c1">#ones = np.ones((1,n), dtype=camPoints.dtype)</span>
        <span class="c1">#epipolarLinesP = self.F.dot( np.vstack((camPoints.T, ones)) ) # Shape (3, n)</span>
        <span class="c1">#epipolarLinesP = epipolarLinesP.T # Shape (n, 3)</span>
        
        <span class="c1"># Get p_y values</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">p_x</span><span class="p">):</span>
            <span class="n">p_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="n">p_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">camPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">p_x</span> <span class="o">=</span> <span class="n">p_x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">p_y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">epipolarLinesP</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p_x</span> <span class="o">+</span> <span class="n">epipolarLinesP</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="n">epipolarLinesP</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">p_y</span> <span class="o">=</span> <span class="n">p_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">projPoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">p_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">p_y</span><span class="p">))</span> <span class="c1"># Shape (n, 2)</span>
        
        <span class="c1">### Triangulate</span>
        <span class="c1"># Apply rectification to cam (already undistorted)</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">camPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify1</span><span class="p">)</span>
        
        <span class="c1"># Apply lens correction to projector and rectify</span>
        <span class="n">Ap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic2</span>
        <span class="n">Dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs2</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">projPoints</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">Ap</span><span class="p">,</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">Ap</span><span class="p">)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rectify2</span><span class="p">)</span>
        
        <span class="n">disparity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,[</span><span class="mi">0</span><span class="p">]])</span>
        
        <span class="n">pc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">camPoints</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="p">)</span> <span class="c1"># Shape (n, 3)</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">getBaseline</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">pc</span><span class="o">/</span><span class="n">disparity</span><span class="p">)</span> <span class="c1"># Shape (n, 3)</span>
        
        <span class="n">pw</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_inv</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">pw</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
        
    
<div class="viewcode-block" id="StereoFTP_PhaseOnly.getPhase">
<a class="viewcode-back" href="../../simplestereo.html#simplestereo.active.StereoFTP_PhaseOnly.getPhase">[docs]</a>
    <span class="k">def</span> <span class="nf">getPhase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">,</span> <span class="n">radius_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an image and get the point cloud.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        imgObj : numpy.ndarray</span>
<span class="sd">            BGR image acquired by the camera.</span>
<span class="sd">        radius_factor : float, optional</span>
<span class="sd">            Radius factor of the pass-band filter. Default to 0.5.</span>
<span class="sd">        roi : tuple, optional</span>
<span class="sd">            Region of interest in the format (x,y,width,height)</span>
<span class="sd">            where x,y is the upper left corner. Default to None.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Point cloud with shape (height,width,3), with height and width </span>
<span class="sd">        same as the input image or selected `roi`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check that is a color image</span>
        <span class="k">if</span> <span class="n">imgObj</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;image must be a BGR color image!&quot;</span><span class="p">)</span>
        
        <span class="n">widthC</span><span class="p">,</span> <span class="n">heightC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">res1</span> <span class="c1"># Camera resolution</span>
        
        <span class="c1"># Undistort camera image</span>
        <span class="n">imgObj</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">roi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Cut image to given roi</span>
            <span class="n">roi_x</span><span class="p">,</span> <span class="n">roi_y</span><span class="p">,</span> <span class="n">roi_w</span><span class="p">,</span> <span class="n">roi_h</span> <span class="o">=</span> <span class="n">roi</span>
            <span class="n">imgObj</span> <span class="o">=</span> <span class="n">imgObj</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">widthC</span><span class="p">,</span><span class="n">heightC</span><span class="p">)</span>
            
        
        <span class="c1">### Estimate camera carrier frequency fc    </span>
        <span class="c1"># Find central stripe on camera image</span>
        <span class="n">objStripe</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">findCentralStripe</span><span class="p">(</span><span class="n">imgObj</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">stripeColor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeSensitivity</span><span class="p">)</span>
        <span class="c1"># Process a copy for triangulation</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">objStripe</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span>               <span class="c1"># Consider distortion</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">distCoeffs1</span><span class="p">,</span>
                        <span class="n">P</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stereoRig</span><span class="o">.</span><span class="n">intrinsic1</span><span class="p">)</span>
        <span class="n">stripe_cam</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># x, y camera points</span>
        
        <span class="c1">### Find world points corresponding to stripe</span>
        <span class="n">stripe_world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangulate</span><span class="p">(</span><span class="n">stripe_cam</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stripeCentralPeak</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        <span class="c1">#return stripe_world</span>
        
        <span class="c1"># For each point (= for each row) estimate fc</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculateCameraFrequency</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">)</span>
        
        <span class="c1">### Build virtual reference plane</span>
        <span class="n">z_plane</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">stripe_world</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">projCoords</span><span class="p">,</span> <span class="n">imgR_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getProjectorMapping</span><span class="p">(</span><span class="n">z_plane</span><span class="p">)</span>
        <span class="n">imgR_gray</span> <span class="o">=</span> <span class="n">imgR_gray</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        <span class="n">projCoords</span> <span class="o">=</span> <span class="n">projCoords</span><span class="p">[</span><span class="n">roi_y</span><span class="p">:</span><span class="n">roi_y</span><span class="o">+</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_x</span><span class="p">:</span><span class="n">roi_x</span><span class="o">+</span><span class="n">roi_w</span><span class="p">]</span>
        
        <span class="c1"># Preprocess image for phase analysis</span>
        <span class="n">imgObj_gray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertGrayscale</span><span class="p">(</span><span class="n">imgObj</span><span class="p">)</span>
        
        <span class="c1"># FFT</span>
        <span class="n">G0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgR_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>     <span class="c1"># FFT on x dimension</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">imgObj_gray</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">roi_w</span><span class="p">)</span>
        
        <span class="c1"># Pass-band filter parameters</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">radius_factor</span><span class="o">*</span><span class="n">fc</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">-</span> <span class="n">radius</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">+</span> <span class="n">radius</span>
        
        
        
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Virtual reference&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Object&#39;</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Virtual reference&quot;</span><span class="p">,</span> <span class="n">imgR_gray</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Object&quot;</span><span class="p">,</span> <span class="n">imgObj</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press a key over the images to continue...&quot;</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
            
            <span class="c1"># Get discrete indexes of frequencies</span>
            <span class="c1">#fIndex = np.argmin( np.abs(freqs.reshape(1,-1) - fc.reshape(-1,1)), axis=1 ) # Shape (roi_h, )</span>
            <span class="c1">#fminIndex = np.argmin( np.abs(freqs.reshape(1,-1) - fmin.reshape(-1,1)), axis=1 ) # Shape (roi_h, )</span>
            <span class="c1">#fmaxIndex = np.argmin( np.abs(freqs.reshape(1,-1) - fmax.reshape(-1,1)), axis=1 ) # Shape (roi_h, )</span>
            <span class="n">fIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fminIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">fmaxIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">fmax</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
                
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Middle row FFT module&quot;</span><span class="p">)</span>
            <span class="c1"># Show module of FFTs</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G0</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G0|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">[:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="n">roi_w</span><span class="o">//</span><span class="mi">2</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;|G|&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="c1"># Show filtered band</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fminIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">freqs</span><span class="p">[</span><span class="n">fmaxIndex</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fc=</span><span class="si">{</span><span class="n">fc</span><span class="p">[</span><span class="n">roi_h</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>    
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Phase filtering</span>
        <span class="n">mask_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmin</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">mask_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">freqs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fmax</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G0</span><span class="p">[</span> <span class="n">mask_low</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">G0</span><span class="p">[</span> <span class="n">mask_high</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Inverse FFT</span>
        <span class="n">g0hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ghat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">G</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Build the new signal and get its phase</span>
        <span class="n">newSignal</span> <span class="o">=</span> <span class="n">ghat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">g0hat</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">newSignal</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">phase</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">roi_h</span><span class="p">,</span><span class="n">roi_w</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">ghat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">g0hat</span><span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">SimpleStereo 1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">simplestereo.active</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2023, decadenza.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>